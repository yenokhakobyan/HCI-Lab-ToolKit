<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCI Collector - Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <h1>Web HCI Collector Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span id="playback-badge" class="playback-badge" style="display: none;">PLAYBACK</span>
                <div class="status-indicator">
                    <span class="status-dot" id="connection-status"></span>
                    <span id="connection-text">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- Left Sidebar - Video and Emotions -->
        <aside class="sidebar-left">
            <!-- Tracking Quality -->
            <div class="panel">
                <div class="panel-title">Tracking Quality <span class="panel-toggle" onclick="togglePanel(this)">&#9660;</span></div>
                <div class="calibration-status">
                    <div class="calib-item">
                        <span class="calib-dot" id="calib-face-detected"></span>
                        <span>Face Detected</span>
                    </div>
                    <div class="calib-item">
                        <span class="calib-dot" id="calib-face-centered"></span>
                        <span>Face Centered</span>
                    </div>
                    <div class="calib-item">
                        <span class="calib-dot" id="calib-face-size"></span>
                        <span>Face Size OK</span>
                    </div>
                    <div class="calib-item">
                        <span class="calib-dot" id="calib-head-pose"></span>
                        <span>Head Straight</span>
                    </div>
                </div>
            </div>

            <!-- Face Mesh Visualization -->
            <div class="panel">
                <div class="panel-title">Face Mesh (468 landmarks) <span class="panel-toggle" onclick="togglePanel(this)">&#9660;</span></div>
                <div class="face-mesh-container">
                    <canvas id="face-canvas"></canvas>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                    <span>Landmarks: <span id="landmark-count">0</span></span>
                    <span>Head Pose: <span id="head-pose">-</span></span>
                </div>
            </div>

            <!-- Cognitive States -->
            <div class="panel">
                <div class="panel-title">Cognitive States <span class="panel-toggle" onclick="togglePanel(this)">&#9660;</span></div>
                <div class="emotion-bars">
                    <div class="emotion-bar">
                        <span class="emotion-label">Confusion</span>
                        <div class="emotion-track">
                            <div class="emotion-fill confusion" id="confusion-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="confusion-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <span class="emotion-label">Engagement</span>
                        <div class="emotion-track">
                            <div class="emotion-fill engagement" id="engagement-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="engagement-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <span class="emotion-label">Boredom</span>
                        <div class="emotion-track">
                            <div class="emotion-fill boredom" id="boredom-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="boredom-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <span class="emotion-label">Frustration</span>
                        <div class="emotion-track">
                            <div class="emotion-fill frustration" id="frustration-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="frustration-value">0%</span>
                    </div>
                </div>
            </div>

            <!-- Session Management -->
            <div class="panel">
                <div class="panel-title">Session Management <span class="panel-toggle" onclick="togglePanel(this)">&#9660;</span></div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn btn-primary" id="create-session-btn" onclick="createNewSession()">+ New Participant Session</button>
                    <div id="participant-link-container" style="display: none;">
                        <label style="font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase;">Participant Link</label>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <input type="text" id="participant-link-input" readonly class="participant-link-input">
                            <button class="btn btn-secondary" onclick="copyParticipantLink()" title="Copy link" style="padding: 6px 8px; flex-shrink: 0;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="link-copy-status" style="font-size: 0.65rem; color: var(--success); display: none; margin-top: 2px;">Copied!</div>
                    </div>
                    <button class="btn btn-secondary" id="export-btn" onclick="exportData()">Export Data</button>
                </div>
            </div>

            <!-- Active Sessions -->
            <div class="panel">
                <div class="panel-title">
                    Sessions
                    <span id="sessions-count" style="font-weight: normal; color: var(--accent-light);">0</span>
                </div>
                <div id="sessions-list" class="sessions-list">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); text-align: center; padding: 8px;">No sessions yet</div>
                </div>
            </div>

            <!-- Load Session -->
            <div class="panel">
                <div class="panel-title">Load Session <span class="panel-toggle" onclick="togglePanel(this)">&#9660;</span></div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" id="load-session-id" placeholder="Enter Session ID..."
                           style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface); color: var(--text-primary); font-size: 0.875rem;">
                    <button class="btn btn-secondary" id="load-session-btn" onclick="loadSessionById()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Load Session
                    </button>
                    <div id="load-session-status" style="font-size: 0.75rem; color: var(--text-secondary); display: none;"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content - Participant View with Tracking Overlays -->
        <main class="main-content">
            <!-- Participant Page View with Eye Tracking and Mouse Overlay -->
            <div class="panel" style="flex: 1; display: flex; flex-direction: column;">
                <div class="panel-title">
                    Participant View
                    <span id="participant-url" style="font-weight: normal; font-size: 0.7rem; margin-left: 10px; color: var(--text-secondary);">Waiting for session...</span>
                </div>
                <!-- Visualization Toolbar -->
                <div class="viz-toolbar" id="viz-toolbar">
                    <button class="viz-btn active" data-mode="trail" onclick="setVizMode('trail')">Trail</button>
                    <button class="viz-btn" data-mode="heatmap" onclick="setVizMode('heatmap')">Heatmap</button>
                    <button class="viz-btn" data-mode="both" onclick="setVizMode('both')">Both</button>
                    <span class="viz-separator"></span>
                    <label class="viz-toggle"><input type="checkbox" id="show-gaze-overlay" checked onchange="toggleOverlayLayer('gaze')"> Gaze</label>
                    <label class="viz-toggle"><input type="checkbox" id="show-mouse-overlay" checked onchange="toggleOverlayLayer('mouse')"> Mouse</label>
                    <label class="viz-toggle"><input type="checkbox" id="show-clicks-overlay" checked onchange="toggleOverlayLayer('clicks')"> Clicks</label>
                    <span class="viz-separator"></span>
                    <span class="viz-source-badge" id="gaze-source-badge">WebGazer</span>
                </div>
                <div class="participant-view-container" id="participant-view-container">
                    <!-- Iframe showing participant's page -->
                    <iframe id="participant-frame" class="participant-frame" src="about:blank"></iframe>

                    <!-- Gaze point overlay -->
                    <div class="gaze-point-overlay" id="gaze-point-overlay"></div>

                    <!-- Mouse cursor overlay -->
                    <div class="mouse-cursor-overlay" id="mouse-cursor-overlay">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M5 3L19 12L12 13L9 20L5 3Z" fill="#4ecca3" stroke="#fff" stroke-width="1"/>
                        </svg>
                    </div>

                    <!-- Click ripple container -->
                    <div id="click-ripple-container"></div>

                    <!-- Gaze trail canvas -->
                    <canvas id="gaze-trail-canvas"></canvas>

                    <!-- Mouse trail canvas -->
                    <canvas id="mouse-trail-canvas"></canvas>

                    <!-- Heatmap canvas -->
                    <canvas id="heatmap-canvas"></canvas>
                </div>
            </div>

            <!-- Data Stream Stats -->
            <div class="data-streams">
                <div class="stream-card">
                    <div class="stream-value" id="gaze-source-label">WebGazer</div>
                    <div class="stream-label">Eye Tracker</div>
                </div>
                <div class="stream-card">
                    <div class="stream-value" id="gaze-rate">0</div>
                    <div class="stream-label">Gaze Hz</div>
                </div>
                <div class="stream-card">
                    <div class="stream-value" id="mouse-events">0</div>
                    <div class="stream-label">Mouse Events</div>
                </div>
                <div class="stream-card">
                    <div class="stream-value" id="click-count">0</div>
                    <div class="stream-label">Clicks</div>
                </div>
                <div class="stream-card">
                    <div class="stream-value" id="keyboard-events">0</div>
                    <div class="stream-label">Key Events</div>
                </div>
            </div>

            <!-- Timeline Panel -->
            <div class="panel timeline-panel">
                <div class="panel-title">
                    Session Timeline
                    <div class="timeline-controls">
                        <button class="timeline-btn" id="timeline-play-pause" title="Play/Pause">
                            <svg id="play-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg id="pause-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        </button>
                        <button class="timeline-btn" id="timeline-live" title="Jump to Live">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="6"/>
                            </svg>
                            LIVE
                        </button>
                        <span class="timeline-time" id="timeline-current-time">0:00</span>
                        <span class="timeline-separator">/</span>
                        <span class="timeline-time" id="timeline-total-time">0:00</span>
                        <div class="speed-control">
                            <button class="speed-btn" data-speed="0.25" onclick="setPlaybackSpeed(0.25, this)">0.25x</button>
                            <button class="speed-btn" data-speed="0.5" onclick="setPlaybackSpeed(0.5, this)">0.5x</button>
                            <button class="speed-btn active" data-speed="1" onclick="setPlaybackSpeed(1, this)">1x</button>
                            <button class="speed-btn" data-speed="2" onclick="setPlaybackSpeed(2, this)">2x</button>
                            <button class="speed-btn" data-speed="4" onclick="setPlaybackSpeed(4, this)">4x</button>
                        </div>
                        <span class="timeline-zoom-indicator" id="timeline-zoom-indicator" style="display:none;">1x</span>
                    </div>
                </div>
                <div class="timeline-container">
                    <!-- Timeline scrubber -->
                    <div class="timeline-track" id="timeline-track">
                        <div class="timeline-progress" id="timeline-progress"></div>
                        <div class="timeline-scrubber" id="timeline-scrubber"></div>
                        <!-- Event markers will be added dynamically -->
                        <div class="timeline-markers" id="timeline-markers"></div>
                    </div>
                    <!-- Mini charts with labels -->
                    <div class="timeline-charts">
                        <div class="timeline-chart-wrapper">
                            <span class="timeline-chart-label">Engagement</span>
                            <canvas id="timeline-engagement-chart" class="timeline-chart" title="Engagement"></canvas>
                        </div>
                        <div class="timeline-chart-wrapper">
                            <span class="timeline-chart-label">Gaze</span>
                            <canvas id="timeline-gaze-chart" class="timeline-chart" title="Gaze Activity"></canvas>
                        </div>
                        <div class="timeline-chart-wrapper">
                            <span class="timeline-chart-label">Events</span>
                            <canvas id="timeline-events-chart" class="timeline-chart" title="Clicks &amp; Keys"></canvas>
                        </div>
                    </div>
                    <!-- Timeline legend -->
                    <div class="timeline-legend">
                        <span class="legend-item"><span class="legend-dot engagement"></span>Engagement</span>
                        <span class="legend-item"><span class="legend-dot gaze"></span>Gaze</span>
                        <span class="legend-item"><span class="legend-dot mouse"></span>Mouse</span>
                        <span class="legend-item"><span class="legend-dot click"></span>Clicks</span>
                        <span class="legend-item"><span class="legend-dot keyboard"></span>Keys</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar - Stats and Log -->
        <aside class="sidebar-right">
            <!-- Session Info -->
            <div class="panel">
                <div class="panel-title">Session Info</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="session-duration">0:00</div>
                        <div class="stat-label">Duration</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-samples">0</div>
                        <div class="stat-label">Samples</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gaze-samples">0</div>
                        <div class="stat-label">Gaze</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="face-samples">0</div>
                        <div class="stat-label">Face</div>
                    </div>
                </div>
            </div>

            <!-- Metrics & Position -->
            <div class="panel">
                <div class="panel-title">Metrics & Position <span class="panel-toggle" onclick="togglePanel(this)">&#9660;</span></div>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div class="stat-item">
                        <div class="stat-value" id="gaze-x">-</div>
                        <div class="stat-label">Gaze X</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gaze-y">-</div>
                        <div class="stat-label">Gaze Y</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mouse-x">-</div>
                        <div class="stat-label">Mouse X</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mouse-y">-</div>
                        <div class="stat-label">Mouse Y</div>
                    </div>
                </div>
                <div class="stats-grid" style="margin-top: 6px;">
                    <div class="stat-item">
                        <div class="stat-value" id="fixation-count">0</div>
                        <div class="stat-label">Fixations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mean-fixation-ms">0</div>
                        <div class="stat-label">Fix Dur</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="saccade-count">0</div>
                        <div class="stat-label">Saccades</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="tracking-quality">-</div>
                        <div class="stat-label">Quality</div>
                    </div>
                </div>
            </div>

            <!-- AOI Dwell Time -->
            <div class="panel">
                <div class="panel-title">AOI Dwell Time <span class="panel-toggle" onclick="togglePanel(this)">&#9660;</span></div>
                <div id="aoi-analysis" class="aoi-container">
                    <div class="aoi-empty">Collecting hover data...</div>
                </div>
            </div>

            <!-- Event Log -->
            <div class="panel" style="flex: 1;">
                <div class="panel-title">
                    Event Log
                    <div class="event-filter-bar">
                        <button class="event-filter-btn active" data-filter="all" onclick="setEventFilter('all', this)">All</button>
                        <button class="event-filter-btn" data-filter="system" onclick="setEventFilter('system', this)">Sys</button>
                        <button class="event-filter-btn" data-filter="mouse" onclick="setEventFilter('mouse', this)">Mouse</button>
                        <button class="event-filter-btn" data-filter="keyboard" onclick="setEventFilter('keyboard', this)">Key</button>
                        <button class="event-filter-btn" data-filter="answer" onclick="setEventFilter('answer', this)">Ans</button>
                        <button class="event-filter-btn" data-filter="gaze" onclick="setEventFilter('gaze', this)">Gaze</button>
                    </div>
                </div>
                <div class="event-log" id="event-log">
                    <div class="event-item">
                        <span class="event-time">--:--:--</span>
                        <span class="event-type">system</span>
                        <span>Dashboard loaded</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Footer -->
        <footer class="footer">
            <div>
                <span style="color: var(--text-secondary);">Session ID: </span>
                <span id="session-id">Not started</span>
            </div>
            <div>
                <span style="color: var(--text-secondary);">WebGazer + MediaPipe + DenseAttNet</span>
            </div>
        </footer>
    </div>

    <!-- Keyboard shortcuts overlay -->
    <div id="shortcuts-overlay" class="shortcuts-overlay" style="display:none;">
        <div class="shortcuts-dialog">
            <div class="shortcuts-title">Keyboard Shortcuts <span class="shortcuts-close" onclick="toggleShortcutsOverlay()">&times;</span></div>
            <div class="shortcuts-grid">
                <kbd>Space</kbd><span>Play / Pause</span>
                <kbd>&larr;</kbd><span>Step back 1s</span>
                <kbd>&rarr;</kbd><span>Step forward 1s</span>
                <kbd>Shift+&larr;</kbd><span>Step back 5s</span>
                <kbd>Shift+&rarr;</kbd><span>Step forward 5s</span>
                <kbd>L</kbd><span>Jump to Live</span>
                <kbd>H</kbd><span>Toggle Heatmap</span>
                <kbd>1</kbd><span>Speed 0.25x</span>
                <kbd>2</kbd><span>Speed 0.5x</span>
                <kbd>3</kbd><span>Speed 1x</span>
                <kbd>4</kbd><span>Speed 2x</span>
                <kbd>5</kbd><span>Speed 4x</span>
                <kbd>E</kbd><span>Export data</span>
                <kbd>?</kbd><span>Show shortcuts</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script type="module" src="/static/js/dashboard.js"></script>
</body>
</html>
