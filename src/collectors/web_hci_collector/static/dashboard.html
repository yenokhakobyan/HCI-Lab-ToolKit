<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCI Collector - Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <h1>Web HCI Collector Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span id="playback-badge" class="playback-badge" style="display: none;">PLAYBACK</span>
                <div class="status-indicator">
                    <span class="status-dot" id="connection-status"></span>
                    <span id="connection-text">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- Left Sidebar - Video and Emotions -->
        <aside class="sidebar-left">
            <!-- Live Webcam Preview -->
            <div class="panel">
                <div class="panel-title">Live Camera Feed</div>
                <div class="video-container" style="position: relative;">
                    <video id="webcam-video" autoplay playsinline muted style="width: 100%; border-radius: 8px; transform: scaleX(-1);"></video>
                    <div id="camera-status" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-secondary); font-size: 0.875rem;">
                        Initializing camera...
                    </div>
                </div>
            </div>

            <!-- Face Mesh Visualization -->
            <div class="panel">
                <div class="panel-title">Face Mesh (468 landmarks)</div>
                <div class="video-container">
                    <canvas id="face-canvas"></canvas>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                    <span>Landmarks: <span id="landmark-count">0</span></span>
                    <span>Head Pose: <span id="head-pose">-</span></span>
                </div>
            </div>

            <!-- Cognitive States -->
            <div class="panel">
                <div class="panel-title">Cognitive States</div>
                <div class="emotion-bars">
                    <div class="emotion-bar">
                        <span class="emotion-label">Confusion</span>
                        <div class="emotion-track">
                            <div class="emotion-fill confusion" id="confusion-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="confusion-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <span class="emotion-label">Engagement</span>
                        <div class="emotion-track">
                            <div class="emotion-fill engagement" id="engagement-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="engagement-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <span class="emotion-label">Boredom</span>
                        <div class="emotion-track">
                            <div class="emotion-fill boredom" id="boredom-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="boredom-value">0%</span>
                    </div>
                    <div class="emotion-bar">
                        <span class="emotion-label">Frustration</span>
                        <div class="emotion-track">
                            <div class="emotion-fill frustration" id="frustration-bar" style="width: 0%"></div>
                        </div>
                        <span class="emotion-value" id="frustration-value">0%</span>
                    </div>
                </div>
            </div>

            <!-- Session Management -->
            <div class="panel">
                <div class="panel-title">Session Management</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn btn-primary" id="create-session-btn" onclick="createNewSession()">+ New Participant Session</button>
                    <div id="participant-link-container" style="display: none;">
                        <label style="font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase;">Participant Link</label>
                        <div style="display: flex; gap: 4px; margin-top: 4px;">
                            <input type="text" id="participant-link-input" readonly class="participant-link-input">
                            <button class="btn btn-secondary" onclick="copyParticipantLink()" title="Copy link" style="padding: 6px 8px; flex-shrink: 0;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="link-copy-status" style="font-size: 0.65rem; color: var(--success); display: none; margin-top: 2px;">Copied!</div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-secondary" id="start-btn" onclick="startCollection()" style="flex: 1;">Start Collection</button>
                        <button class="btn btn-secondary" id="export-btn" onclick="exportData()" style="flex: 1;">Export Data</button>
                    </div>
                </div>
            </div>

            <!-- Active Sessions -->
            <div class="panel">
                <div class="panel-title">
                    Sessions
                    <span id="sessions-count" style="font-weight: normal; color: var(--accent-light);">0</span>
                </div>
                <div id="sessions-list" class="sessions-list">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); text-align: center; padding: 8px;">No sessions yet</div>
                </div>
            </div>

            <!-- Load Session -->
            <div class="panel">
                <div class="panel-title">Load Session</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" id="load-session-id" placeholder="Enter Session ID..."
                           style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface); color: var(--text-primary); font-size: 0.875rem;">
                    <button class="btn btn-secondary" id="load-session-btn" onclick="loadSessionById()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 6px;">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        Load Session
                    </button>
                    <div id="load-session-status" style="font-size: 0.75rem; color: var(--text-secondary); display: none;"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content - Participant View with Tracking Overlays -->
        <main class="main-content">
            <!-- Participant Page View with Eye Tracking and Mouse Overlay -->
            <div class="panel" style="flex: 1; display: flex; flex-direction: column;">
                <div class="panel-title">
                    Participant View
                    <span id="participant-url" style="font-weight: normal; font-size: 0.7rem; margin-left: 10px; color: var(--text-secondary);">Waiting for session...</span>
                </div>
                <div class="participant-view-container" id="participant-view-container">
                    <!-- Iframe showing participant's page -->
                    <iframe id="participant-frame" class="participant-frame" src="about:blank"></iframe>

                    <!-- Gaze point overlay -->
                    <div class="gaze-point-overlay" id="gaze-point-overlay"></div>

                    <!-- Mouse cursor overlay -->
                    <div class="mouse-cursor-overlay" id="mouse-cursor-overlay">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M5 3L19 12L12 13L9 20L5 3Z" fill="#4ecca3" stroke="#fff" stroke-width="1"/>
                        </svg>
                    </div>

                    <!-- Click ripple container -->
                    <div id="click-ripple-container"></div>

                    <!-- Gaze trail canvas -->
                    <canvas id="gaze-trail-canvas"></canvas>

                    <!-- Mouse trail canvas -->
                    <canvas id="mouse-trail-canvas"></canvas>
                </div>
            </div>

            <!-- Data Stream Stats -->
            <div class="data-streams">
                <div class="stream-card">
                    <div class="stream-value" id="gaze-rate">0</div>
                    <div class="stream-label">Gaze Hz</div>
                </div>
                <div class="stream-card">
                    <div class="stream-value" id="mouse-events">0</div>
                    <div class="stream-label">Mouse Events</div>
                </div>
                <div class="stream-card">
                    <div class="stream-value" id="click-count">0</div>
                    <div class="stream-label">Clicks</div>
                </div>
                <div class="stream-card">
                    <div class="stream-value" id="keyboard-events">0</div>
                    <div class="stream-label">Key Events</div>
                </div>
            </div>

            <!-- Timeline Panel -->
            <div class="panel timeline-panel">
                <div class="panel-title">
                    Session Timeline
                    <div class="timeline-controls">
                        <button class="timeline-btn" id="timeline-play-pause" title="Play/Pause">
                            <svg id="play-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg id="pause-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        </button>
                        <button class="timeline-btn" id="timeline-live" title="Jump to Live">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="6"/>
                            </svg>
                            LIVE
                        </button>
                        <span class="timeline-time" id="timeline-current-time">0:00</span>
                        <span class="timeline-separator">/</span>
                        <span class="timeline-time" id="timeline-total-time">0:00</span>
                    </div>
                </div>
                <div class="timeline-container">
                    <!-- Timeline scrubber -->
                    <div class="timeline-track" id="timeline-track">
                        <div class="timeline-progress" id="timeline-progress"></div>
                        <div class="timeline-scrubber" id="timeline-scrubber"></div>
                        <!-- Event markers will be added dynamically -->
                        <div class="timeline-markers" id="timeline-markers"></div>
                    </div>
                    <!-- Mini charts with labels -->
                    <div class="timeline-charts">
                        <div class="timeline-chart-wrapper">
                            <span class="timeline-chart-label">Engagement</span>
                            <canvas id="timeline-engagement-chart" class="timeline-chart" title="Engagement"></canvas>
                        </div>
                        <div class="timeline-chart-wrapper">
                            <span class="timeline-chart-label">Gaze</span>
                            <canvas id="timeline-gaze-chart" class="timeline-chart" title="Gaze Activity"></canvas>
                        </div>
                        <div class="timeline-chart-wrapper">
                            <span class="timeline-chart-label">Events</span>
                            <canvas id="timeline-events-chart" class="timeline-chart" title="Clicks &amp; Keys"></canvas>
                        </div>
                    </div>
                    <!-- Timeline legend -->
                    <div class="timeline-legend">
                        <span class="legend-item"><span class="legend-dot engagement"></span>Engagement</span>
                        <span class="legend-item"><span class="legend-dot gaze"></span>Gaze</span>
                        <span class="legend-item"><span class="legend-dot mouse"></span>Mouse</span>
                        <span class="legend-item"><span class="legend-dot click"></span>Clicks</span>
                        <span class="legend-item"><span class="legend-dot keyboard"></span>Keys</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar - Stats and Log -->
        <aside class="sidebar-right">
            <!-- Session Info -->
            <div class="panel">
                <div class="panel-title">Session Info</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="session-duration">0:00</div>
                        <div class="stat-label">Duration</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-samples">0</div>
                        <div class="stat-label">Samples</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gaze-samples">0</div>
                        <div class="stat-label">Gaze</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="face-samples">0</div>
                        <div class="stat-label">Face</div>
                    </div>
                </div>
            </div>

            <!-- Gaze Position -->
            <div class="panel">
                <div class="panel-title">Current Position</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="gaze-x">-</div>
                        <div class="stat-label">Gaze X</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gaze-y">-</div>
                        <div class="stat-label">Gaze Y</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mouse-x">-</div>
                        <div class="stat-label">Mouse X</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mouse-y">-</div>
                        <div class="stat-label">Mouse Y</div>
                    </div>
                </div>
            </div>

            <!-- Event Log -->
            <div class="panel" style="flex: 1;">
                <div class="panel-title">Event Log</div>
                <div class="event-log" id="event-log">
                    <div class="event-item">
                        <span class="event-time">--:--:--</span>
                        <span class="event-type">system</span>
                        <span>Dashboard loaded</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Footer -->
        <footer class="footer">
            <div>
                <span style="color: var(--text-secondary);">Session ID: </span>
                <span id="session-id">Not started</span>
            </div>
            <div>
                <span style="color: var(--text-secondary);">WebGazer + MediaPipe + DenseAttNet</span>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script type="module" src="/static/js/dashboard.js"></script>
</body>
</html>
